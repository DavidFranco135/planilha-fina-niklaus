<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanças</title>
    
    <!-- Configurações para Web App (PWA) e Favicons -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/money-bag.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/32/money-bag.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://img.icons8.com/fluency/192/money-bag.png">
    
    <!-- Importação de bibliotecas externas: Tailwind CSS, jsPDF e FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #8b5cf6;
            --bg-dark: #0f172a;
        }

        /* Estilização Geral do Body */
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f1f5f9;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Efeito de Vidro Fosco (Glassmorphism) */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animação de Loading */
        .loader { 
            border-top-color: var(--primary); 
            animation: spinner 0.8s ease-in-out infinite; 
        }
        @keyframes spinner { to { transform: rotate(360deg); } }

        /* Animações de Entrada de Elementos */
        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Destaque para item ativo na Sidebar */
        .sidebar-item-active {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0) 100%);
            color: var(--primary);
            border-right: 3px solid var(--primary);
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }

        /* Customização de Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Ajuste de inputs para dispositivos móveis */
        input, select, textarea { font-size: 16px !important; color: white !important; }
        
        @media (max-width: 640px) {
            .text-3xl { font-size: 1.5rem !important; }
            .p-8 { padding: 1.25rem !important; }
            .p-10 { padding: 1.5rem !important; }
            .rounded-[2.5rem] { border-radius: 1.5rem !important; }
            .rounded-[3rem] { border-radius: 2rem !important; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .notification-layer {
            z-index: 9999 !important;
        }

        /* Efeito de desfoque para ocultar valores */
        .blur-value {
            filter: blur(8px);
            opacity: 0.6;
            user-select: none;
            pointer-events: none;
        }

        .transition-value {
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        /* Estilização do Toggle Switch (Configurações) */
        .switch {
          position: relative;
          display: inline-block;
          width: 44px;
          height: 24px;
        }

        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #334155;
          transition: .4s;
          border-radius: 34px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 18px;
          width: 18px;
          left: 3px;
          bottom: 3px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: var(--primary);
        }

        input:checked + .slider:before {
          transform: translateX(20px);
        }
    </style>

    <!-- Mapeamento de Módulos (ESM) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js",
        "htm": "https://esm.sh/htm@3.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom';
        import htm from 'htm';
        import { initializeApp } from "firebase/app";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, 
            addDoc, query, where, onSnapshot, deleteDoc, updateDoc, writeBatch, serverTimestamp, orderBy, getDocs
        } from "firebase/firestore";

        // Bind do htm para usar sintaxe similar a JSX sem necessidade de build step
        const html = htm.bind(React.createElement);
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD9vzjo_nrSjaRZ5sXK7G4fhnTTxIW7c-k",
            authDomain: "planilha-fina.firebaseapp.com",
            projectId: "planilha-fina",
            storageBucket: "planilha-fina.firebasestorage.app",
            messagingSenderId: "288466007894",
            appId: "1:288466007894:web:e917cc6eeac421671188f7"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // Carregamento prévio de efeitos sonoros
        const bellSound = new Audio('https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3');
        const trashSound = new Audio('https://assets.mixkit.co/active_storage/sfx/1474/1474-preview.mp3');
        trashSound.volume = 0.3; // Volume reduzido para o som de exclusão

        /**
         * Componente de Avatar reutilizável
         */
        const Avatar = ({ src, size = 'md' }) => {
            const classes = { sm: 'w-8 h-8 rounded-lg', md: 'w-10 h-10 rounded-xl', lg: 'w-16 h-16 rounded-2xl' };
            return html`
                <div className="${classes[size]} bg-slate-700 flex items-center justify-center overflow-hidden border-2 border-slate-600">
                    ${src ? html`<img src="${src}" className="w-full h-full object-cover" />` : html`<i className="fas fa-user text-slate-500"></i>`}
                </div>
            `;
        };

        /**
         * Componente Principal da Aplicação
         */
        const App = () => {
            // Estados Principais de Usuário e UI
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            
            // Filtros de Visualização
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().substring(0, 7));
            const [typeFilter, setTypeFilter] = useState('ALL');
            const [methodFilter, setMethodFilter] = useState('ALL');
            const [showValues, setShowValues] = useState(true);
            const [soundEnabled, setSoundEnabled] = useState(true);
            
            // Modos de Balanço (Mensal vs Acumulado/Personalizado)
            const [balanceMode, setBalanceMode] = useState('MONTHLY');
            const [accumStart, setAccumStart] = useState('');
            const [accumEnd, setAccumEnd] = useState('');
            const [showCustomPeriod, setShowCustomPeriod] = useState(false);

            // Referências de UI
            const fileInputPrincipalRef = useRef(null);
            const fileInputSecondaryRef = useRef(null);
            const notificationDropdownRef = useRef(null);

            // Estado para nova transação
            const [newTx, setNewTx] = useState({ 
                description: '', amount: '', type: 'INCOME', 
                date: new Date().toISOString().split('T')[0],
                method: 'PIX', isPaid: true, installments: 1, isSecondary: false 
            });

            // Estados de Autenticação
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [isRegistering, setIsRegistering] = useState(false);
            const [isRecovering, setIsRecovering] = useState(false);
            const [authLoading, setAuthLoading] = useState(false);
            const [keepConnected, setKeepConnected] = useState(true);

            // Perfil das Contas (Principal e Secundária)
            const [profileName, setProfileName] = useState('');
            const [secondaryName, setSecondaryName] = useState('');
            const [profilePhoto, setProfilePhoto] = useState('');
            const [secondaryPhoto, setSecondaryPhoto] = useState('');

            // Controle de visualização de conta secundária no extrato
            const [viewSecondaryTransactions, setViewSecondaryTransactions] = useState(false);

            // Sugestões e Notificações
            const [suggestionText, setSuggestionText] = useState('');
            const [sendingSuggestion, setSendingSuggestion] = useState(false);
            const [userSuggestions, setUserSuggestions] = useState([]);
            const [adminSuggestions, setAdminSuggestions] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const [showNotificationList, setShowNotificationList] = useState(false);

            const isAdmin = useMemo(() => user?.email?.toLowerCase() === 'niklaus', [user]);

            // Funções de feedback sonoro
            const playMoneySfx = () => {
                if (soundEnabled) {
                    bellSound.currentTime = 0;
                    bellSound.play().catch(e => console.log('Audio play blocked'));
                }
            };

            const playTrashSfx = () => {
                if (soundEnabled) {
                    trashSound.currentTime = 0;
                    trashSound.play().catch(e => console.log('Audio play blocked'));
                }
            };

            /**
             * Inicia a sincronização de dados em tempo real com o Firestore
             */
            const startDataSync = (sid) => {
                setLoading(true);
                
                // Monitoramento de dados do usuário
                const unsubUser = onSnapshot(doc(db, "users", sid), (s) => {
                    if (s.exists()) {
                        const userData = { id: s.id, ...s.data() };
                        // Bloqueio de segurança para usuários não pagos (exceto adm)
                        if (userData.email.toLowerCase() !== 'niklaus' && userData.status !== 'paid') {
                             alert("Acesso Bloqueado.");
                             handleLogout();
                             return;
                        }
                        setUser(userData);
                        setProfileName(userData.appName || 'Meu Perfil');
                        setSecondaryName(userData.secondaryName || 'Conta 2');
                        setProfilePhoto(userData.photoURL || '');
                        setSecondaryPhoto(userData.secondaryPhotoURL || '');
                        setSoundEnabled(userData.soundEnabled !== undefined ? userData.soundEnabled : true);
                    } else handleLogout();
                });

                // Monitoramento das transações do usuário
                const q = query(collection(db, "transactions"), where("userId", "==", sid));
                const unsubTx = onSnapshot(q, (s) => {
                    const docs = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setTransactions(docs.sort((a, b) => {
                        const dateA = a.createdAt?.seconds || 0;
                        const dateB = b.createdAt?.seconds || 0;
                        return dateB - dateA;
                    }));
                    setLoading(false);
                });

                // Monitoramento de sugestões (feedback do admin)
                let unsubSugg = () => {};
                if (sid === 'niklaus') {
                    const qs = query(collection(db, "suggestions"), orderBy("createdAt", "desc"));
                    unsubSugg = onSnapshot(qs, (s) => {
                        setAdminSuggestions(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                } else {
                    const qsUser = query(collection(db, "suggestions"), where("userId", "==", sid));
                    unsubSugg = onSnapshot(qsUser, (s) => {
                        const suggestions = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        setUserSuggestions(suggestions);
                        const unread = suggestions.filter(sug => sug.reply && sug.replyViewed === false).length;
                        setUnreadCount(unread);
                    });
                }

                return () => { unsubUser(); unsubTx(); unsubSugg(); };
            };

            // Efeito para checar persistência de login ao carregar
            useEffect(() => {
                const sid = localStorage.getItem('belaju_sid') || sessionStorage.getItem('belaju_sid');
                if (sid) return startDataSync(sid);
                setLoading(false);
            }, []);

            // Efeito para fechar dropdown de notificações ao clicar fora
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationDropdownRef.current && !notificationDropdownRef.current.contains(event.target)) {
                        setShowNotificationList(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // Notificações formatadas (respostas do admin)
            const notifications = useMemo(() => {
                return [...userSuggestions]
                    .filter(sug => sug.reply)
                    .sort((a, b) => (b.repliedAt?.seconds || 0) - (a.repliedAt?.seconds || 0));
            }, [userSuggestions]);

            /**
             * Lógica de Autenticação (Login, Cadastro, Recuperação)
             */
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthLoading(true);
                const safeId = email.toLowerCase().trim().replace(/[^a-z0-9]/g, '_');
                try {
                    const ref = doc(db, "users", safeId);
                    const s = await getDoc(ref);
                    
                    // Caso: Recuperação de Senha (envia sugestão ao sistema)
                    if (isRecovering) {
                        if (s.exists()) {
                            await addDoc(collection(db, "suggestions"), {
                                userId: 'system',
                                userEmail: email,
                                message: `SOLICITAÇÃO DE RECUPERAÇÃO DE SENHA PARA O USUÁRIO: ${email}`,
                                createdAt: serverTimestamp(),
                                reply: null,
                                repliedAt: null,
                                replyViewed: false
                            });
                            alert("Solicitação enviada! Verifique sua caixa de entrada em breve ou contate o administrador.");
                            setIsRecovering(false);
                        } else {
                            alert("Usuário não encontrado.");
                        }
                        setAuthLoading(false);
                        return;
                    }

                    // Caso: Cadastro de novo usuário
                    if (isRegistering) {
                        if (s.exists()) alert("E-mail já cadastrado");
                        else {
                            await setDoc(ref, { 
                                email, 
                                password: pass, 
                                appName: 'Meu Perfil', 
                                secondaryName: 'Conta 2', 
                                photoURL: '', 
                                secondaryPhotoURL: '',
                                soundEnabled: true,
                                status: 'pending' 
                            });
                            alert("Conta criada!");
                        }
                    } else {
                        // Caso: Login convencional
                        if (s.exists() && s.data().password === pass) {
                            if (s.data().status === 'paid' || email.toLowerCase() === 'niklaus') {
                                const storage = keepConnected ? localStorage : sessionStorage;
                                storage.setItem('belaju_sid', safeId);
                                startDataSync(safeId);
                            } else alert("Acesso restrito, efetue o pagamento para usar o App.");
                        } else alert("Dados inválidos");
                    }
                } catch (err) { alert("Erro de conexão"); }
                finally { setAuthLoading(false); }
            };

            /**
             * Limpa dados de sessão ao sair
             */
            const handleLogout = () => {
                localStorage.removeItem('belaju_sid');
                sessionStorage.removeItem('belaju_sid');
                setUser(null);
                setTransactions([]);
                setLoading(false);
            };

            /**
             * Exclusão de uma transação individual
             */
            const handleDeleteTransaction = async (e, id) => {
                e.preventDefault();
                e.stopPropagation();
                if (confirm("Deseja realmente excluir este registro?")) {
                    try {
                        await deleteDoc(doc(db, "transactions", id));
                        playTrashSfx();
                    } catch (err) {
                        alert("Erro ao excluir registro.");
                    }
                }
            };

            /**
             * Exclusão total da conta e dados vinculados
             */
            const handleDeleteAccount = async () => {
                if (confirm("ATENÇÃO: Isso excluirá permanentemente sua conta e todos os seus dados. Deseja continuar?")) {
                    const sid = user.id;
                    setLoading(true);
                    try {
                        const batch = writeBatch(db);
                        // Apaga transações
                        const q = query(collection(db, "transactions"), where("userId", "==", sid));
                        const snapshot = await getDocs(q);
                        snapshot.forEach((d) => batch.delete(d.ref));
                        
                        // Apaga sugestões
                        const sugQ = query(collection(db, "suggestions"), where("userId", "==", sid));
                        const sugSnapshot = await getDocs(sugQ);
                        sugSnapshot.forEach((d) => batch.delete(d.ref));

                        // Apaga documento do usuário
                        batch.delete(doc(db, "users", sid));
                        await batch.commit();
                        playTrashSfx();
                        alert("Conta excluída com sucesso.");
                        handleLogout();
                    } catch (e) {
                        alert("Erro ao excluir conta.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            /**
             * Navegação entre meses no filtro
             */
            const changeMonth = (offset) => {
                const [year, month] = filterMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + offset, 1);
                setFilterMonth(date.toISOString().substring(0, 7));
                if (!accumStart || !accumEnd) {
                    setBalanceMode('MONTHLY');
                }
            };

            // Funções de abertura de modais de edição/criação
            const openEdit = (tx) => {
                setEditingId(tx.id);
                setNewTx({ 
                    ...tx, 
                    amount: (tx.amount || 0).toString().replace('.', ','),
                    date: tx.date ? tx.date.split('T')[0] : new Date().toISOString().split('T')[0]
                });
                setShowModal(true);
            };

            const openAddTransaction = (secondary = false) => {
                setEditingId(null);
                setNewTx({ 
                    description: '', amount: '', type: 'EXPENSE', 
                    date: new Date().toISOString().split('T')[0], 
                    method: 'PIX', isPaid: true, installments: 1,
                    isSecondary: secondary
                });
                setShowModal(true);
            };

            /**
             * Salva ou atualiza transação (suporta parcelamento automático no crédito)
             */
            const saveTransaction = async (e) => {
                e.preventDefault();
                const totalAmountInput = parseFloat(newTx.amount.toString().replace(',', '.')) || 0;
                const instCount = parseInt(newTx.installments) || 1;
                try {
                    if (editingId) {
                        // Edição simples
                        await updateDoc(doc(db, "transactions", editingId), { 
                            ...newTx, amount: totalAmountInput, 
                            date: new Date(newTx.date + "T12:00:00").toISOString() 
                        });
                    } else if (instCount > 1 && newTx.method === 'CREDITO' && newTx.type === 'EXPENSE') {
                        // Lógica de Parcelamento (Cria múltiplos registros em batch)
                        const batch = writeBatch(db);
                        const baseDate = new Date(newTx.date + "T12:00:00");
                        const installmentValue = totalAmountInput / instCount;
                        
                        for (let i = 0; i < instCount; i++) {
                            const pDate = new Date(baseDate);
                            pDate.setMonth(baseDate.getMonth() + i);
                            const newDocRef = doc(collection(db, "transactions"));
                            batch.set(newDocRef, {
                                ...newTx,
                                amount: installmentValue,
                                totalValue: totalAmountInput,
                                currentInstallment: i + 1,
                                totalInstallments: instCount,
                                date: pDate.toISOString(),
                                userId: user.id,
                                installments: 1,
                                createdAt: serverTimestamp()
                            });
                        }
                        await batch.commit();
                        playMoneySfx();
                    } else {
                        // Cadastro simples de transação
                        await addDoc(collection(db, "transactions"), { 
                            ...newTx, amount: totalAmountInput, 
                            date: new Date(newTx.date + "T12:00:00").toISOString(), 
                            userId: user.id,
                            createdAt: serverTimestamp()
                        });
                        playMoneySfx();
                    }
                    setShowModal(false);
                } catch (e) { alert("Erro ao salvar"); }
            };

            /**
             * Upload de foto de perfil (conversão para base64)
             */
            const handlePhotoUpload = (e, target) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (target === 'principal') setProfilePhoto(reader.result);
                    else setSecondaryPhoto(reader.result);
                };
                reader.readAsDataURL(file);
            };

            /**
             * Envio de feedback/sugestão
             */
            const sendSuggestion = async () => {
                if (!suggestionText.trim()) return;
                setSendingSuggestion(true);
                try {
                    await addDoc(collection(db, "suggestions"), {
                        userId: user.id,
                        userEmail: user.email,
                        message: suggestionText,
                        createdAt: serverTimestamp(),
                        reply: null,
                        repliedAt: null,
                        replyViewed: false
                    });
                    setSuggestionText('');
                    alert("Obrigado! Sua sugestão foi enviada com sucesso.");
                } catch (e) { alert("Erro ao enviar sugestão."); }
                finally { setSendingSuggestion(false); }
            };

            const markReplyAsViewed = async (sugId) => {
                try {
                    await updateDoc(doc(db, "suggestions", sugId), { replyViewed: true });
                } catch (e) { console.error(e); }
            };

            /**
             * Compartilhamento do app (Web Share API)
             */
            const handleAppShare = async () => {
                const shareData = {
                    title: 'GestorFinanceiro - Controle Financeiro Premium',
                    text: 'Domine suas finanças com o GestorFinanceiro! Acesse agora pelo link e garanta sua versão Premium com todas as funcionalidades liberadas:',
                    url: window.location.href
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`);
                        alert("Link de convite e informações de acesso copiados para a área de transferência!");
                    }
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            };

            // Memoized: Transações filtradas para exibição atual
            const currentTransactions = useMemo(() => {
                let base;
                // Escolha da base (Principal vs Secundária)
                if (activeTab === 'transactions') {
                    base = viewSecondaryTransactions ? transactions.filter(t => t.isSecondary) : transactions.filter(t => !t.isSecondary);
                } else if (activeTab === 'secondary') {
                    base = transactions.filter(t => t.isSecondary);
                } else {
                    base = transactions.filter(t => !t.isSecondary);
                }

                // Filtragem por Período
                let filteredByDate = base;
                if (balanceMode === 'ACCUMULATED') {
                    if (accumStart && accumEnd) {
                        filteredByDate = base.filter(t => {
                            const d = (t.date || '').split('T')[0];
                            return d >= accumStart && d <= accumEnd;
                        });
                    }
                } else {
                    filteredByDate = base.filter(t => (t.date || '').startsWith(filterMonth));
                }

